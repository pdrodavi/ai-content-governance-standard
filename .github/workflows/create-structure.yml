name: Create initial folder/file structure

on:
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to commit to'
        required: false
        default: 'main'
      commit_message:
        description: 'Commit message'
        required: false
        default: 'Add initial folder/file structure'

permissions:
  contents: write

jobs:
  create-structure:
    runs-on: ubuntu-latest
    env:
      BRANCH: ${{ github.event.inputs.branch || 'main' }}
      COMMIT_MSG: ${{ github.event.inputs.commit_message || 'Add initial folder/file structure' }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Create folder/file structure and commit
        run: |
          set -euo pipefail

          files=(
            README.md
            CHANGELOG.md
            LICENSE.md
            docs/00-introducao.md
            docs/01-escopo-e-objetivos.md
            docs/02-premissas-normativas.md
            docs/03-problema-juridico.md
            docs/04-threat-model-legal.md
            docs/05-estrategias-de-mitigacao.md
            docs/06-arquitetura-de-governanca.md
            docs/07-posicionamento-do-llm.md
            docs/08-fluxo-operacional.md
            docs/09-modelo-de-decisao-versionado.md
            docs/10-openapi-decisao-de-politica.md
            docs/11-opa-rego-politicas-executaveis.md
            docs/12-auditoria-e-evidencias.md
            docs/annexes/A-brasil.md
            docs/annexes/B-uniao-europeia.md
            docs/annexes/C-estados-unidos.md
            docs/aias/aia-dpia-completo.md
            docs/auditoria/checklist-auditoria-externa.md
            docs/incidentes/runbook-incidente-regulatorio.md
            diagrams/llm-posicionamento.svg
            diagrams/fluxo-operacional.svg
            diagrams/regras-de-politica.svg
          )

          created=()
          skipped=()

          for f in "${files[@]}"; do
            dir=$(dirname "$f")
            mkdir -p "$dir"
            if [ -e "$f" ]; then
              skipped+=("$f")
              continue
            fi

            case "$f" in
              LICENSE.md)
                cat > "$f" <<'EOF'
Creative Commons Attribution 4.0 International (CC BY 4.0)
SPDX-License-Identifier: CC-BY-4.0

Copyright (c) 2026 pdrodavi

This work is licensed under the Creative Commons Attribution 4.0 International License.
You are free to:
- Share — copy and redistribute the material in any medium or format
- Adapt — remix, transform, and build upon the material for any purpose, even commercially.

Under the following terms:
- Attribution — You must give appropriate credit, provide a link to the license, and indicate if changes were made.
- No additional restrictions — You may not apply legal terms or technological measures that legally restrict others from doing anything the license permits.

Full license text: https://creativecommons.org/licenses/by/4.0/legalcode
EOF
                ;;
              diagrams/llm-posicionamento.svg)
                cat > "$f" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600">
  <title>llm-posicionamento</title>
</svg>
EOF
                ;;
              diagrams/fluxo-operacional.svg)
                cat > "$f" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600">
  <title>fluxo-operacional</title>
</svg>
EOF
                ;;
              diagrams/regras-de-politica.svg)
                cat > "$f" <<'EOF'
<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600" viewBox="0 0 800 600">
  <title>regras-de-politica</title>
</svg>
EOF
                ;;
              *)
                # create empty markdown file
                : > "$f"
                ;;
            esac

            created+=("$f")
          done

          echo "Created files:"
          for c in "${created[@]}"; do echo "  - $c"; done

          if [ ${#skipped[@]} -gt 0 ]; then
            echo "Skipped existing files:"
            for s in "${skipped[@]}"; do echo "  - $s"; done
          fi

          if [ ${#created[@]} -eq 0 ]; then
            echo "No new files to commit. Exiting."
            exit 0
          fi

          # Configure Git author
          git config user.name "${GITHUB_ACTOR:-github-actions}"
          git config user.email "${GITHUB_ACTOR:-github-actions}@users.noreply.github.com"

          # Stage and commit only newly created files
          git add "${created[@]}"
          git commit -m "${COMMIT_MSG}"
          git push origin "${BRANCH}"

        shell: bash